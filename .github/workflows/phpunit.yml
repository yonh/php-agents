name: PHPUnit

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, reopened, synchronize, edited]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  phpunit:
    name: PHPUnit (PHP 8.5)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup composer cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.5
          coverage: xdebug
          extensions: mbstring, xml

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Run PHPUnit (generate junit + clover)
        # generate junit.xml for checks and clover.xml for coverage
        run: |
          vendor/bin/phpunit --configuration phpunit.xml --log-junit junit.xml --coverage-clover=clover.xml || true

      - name: Upload junit artifact
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-junit
          path: junit.xml

      - name: Upload clover artifact (coverage)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-clover
          path: clover.xml

      # - name: Publish test results to GitHub Checks (PR annotations)
      #   uses: dorny/test-reporter@v1
      #   if: always()
      #   with:
      #     name: PHPUnit
      #     path: junit.xml
      #     reporter: github-pr-check

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: clover.xml
          token: ${{ secrets.CODECOV_TOKEN }}

